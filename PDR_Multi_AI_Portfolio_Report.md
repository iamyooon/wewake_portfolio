# PDR: 다중 AI 기반 포트폴리오 평가보고서 생성 시스템

**작성일**: 2026년 1월 26일  
**버전**: 1.0  
**목적**: 두 개 이상의 AI 서비스를 활용하여 주식 포트폴리오 평가보고서를 평가/보완하여 견고한 최종 리포트를 생성하는 시스템

---

## 1. 프로젝트 개요

### 1.1 비전
- **목표**: 여러 AI 모델의 협업을 통해 단일 AI보다 정확하고 견고한 포트폴리오 평가보고서 생성
- **핵심 가치**: 
  - 다각도 검증을 통한 보고서 품질 향상
  - AI 모델별 강점 활용 (예: OpenAI의 구조화, Grok의 비판적 분석, Gemini의 데이터 분석)
  - 점진적 개발 (로컬 → 웹 → 앱)

### 1.2 현재 상태
- ✅ 로컬 스크립트 기반 OpenAI + Grok 협업 시스템 구축 완료
- ✅ 포트폴리오 프롬프트 및 보고서 템플릿 정의 완료
- ✅ 자동화 스크립트 (Windows Task Scheduler 연동)

### 1.3 최근 업데이트 (2026-02)
추가·변경된 기능은 **[docs/Changelog.md](docs/Changelog.md)**에 정리되어 있습니다.
- API: temperature=0 통일(CAGR 변동 완화), CAGR 전용 테스트 옵션(`--test-cagr-only`, `--test-cagr-runs N`)
- 보고서: 구조 재구성(실행요약→CAGR→시나리오→자산추이→액션플랜), 구간별 감쇠 AI 제안, 자산 추이 억원·연말 반영, 2035년 4% 월인출 요약
- 데이터: 미국 주가 정규장 종가 기준 + 애프터마켓 명시
- 디버그: Debug Step 0(환율·주가), `--check-prices`

---

## 2. 기능 요구사항

### 2.1 핵심 기능

#### 2.1.1 포트폴리오 데이터 입력
- **법인/개인 계좌별 보유 종목 정보**
  - 종목명, 보유 수량, 평균 단가
  - 계좌 구분 (법인/개인)
- **현금 보유액**
- **목표 설정** (예: 2030년 25억 원)
- **운영 전략** (스윙 전략, 자동매수/매도 설정 등)

#### 2.1.2 실시간 시장 데이터 수집
- **환율 정보** (USD/KRW 실시간)
- **주가 정보** (전일 종가 기준)
  - 미국 주식: Stooq.com, Yahoo Finance
  - 국내 주식/ETF: 네이버 금융
- **시장 현황** (주요 종목 등락률, 리스크 요인)

#### 2.1.3 다중 AI 협업 프로세스
```
[입력] 포트폴리오 데이터 + 시장 데이터
    ↓
[Step 1] AI-1 (주 작성자): 초안 보고서 생성
    ↓
[Step 2] AI-2 (리뷰어): 초안 검토 및 코멘트 제공
    ↓
[Step 3] AI-3 (선택적, 검증자): 추가 검증 또는 보완
    ↓
[Step 4] AI-1 또는 AI-2: 리뷰 반영하여 최종 보고서 생성
    ↓
[출력] 최종 보고서 (마크다운 형식)
```

**AI 역할 분담 예시:**
- **OpenAI (GPT-4o)**: 구조화된 보고서 초안 작성, 최종 통합
- **Grok (grok-4)**: 비판적 리뷰, 논리성 검증, 개선 제안
- **Gemini (선택)**: 데이터 정확성 검증, 수치 계산 검토

#### 2.1.4 보고서 구성 요소
1. **포트폴리오 운영 목표**
2. **마켓 현황** (실시간 환율, 종목 등락, 리스크 요인)
3. **자산 현황표** (법인/개인 계좌별 상세 내역)
4. **목표 달성 로드맵 점검**
   - 기준 시나리오 테이블 (Bear/Base/Bull)
   - 연도별 자산 추이 비교 분석
   - 목표 달성 확률 평가
5. **생활비 인출 시나리오**
6. **매니저 코멘트 & 액션 플랜**

#### 2.1.5 보고서 품질 검증
- **정확성 검증**: 수치 계산, 환율 적용, 자산 합계
- **완성도 검증**: 필수 섹션 포함 여부
- **논리성 검증**: 분석과 결론의 연결성
- **일관성 검증**: 이전 보고서와의 일관성

### 2.2 부가 기능

#### 2.2.1 보고서 히스토리 관리
- 날짜별 보고서 저장 및 조회
- 보고서 비교 기능 (시계열 분석)
- 보고서 검색 (키워드, 날짜 범위)

#### 2.2.2 설정 관리
- AI 모델 선택 및 조합 설정
- 프롬프트 템플릿 커스터마이징
- 보고서 형식 설정 (마크다운, PDF, HTML)

#### 2.2.3 알림 및 자동화
- 일일 보고서 자동 생성 (스케줄러)
- 중요 이벤트 알림 (목표 달성 임박, 리스크 증가 등)

---

## 3. 기술 스택

### 3.1 Phase 1: 로컬 스크립트 (현재)
- **언어**: Python 3.7+
- **라이브러리**:
  - `requests`: API 호출
  - `pathlib`: 파일 경로 관리
  - `datetime`: 날짜/시간 처리
  - `argparse`: CLI 인자 파싱
- **외부 서비스**:
  - OpenAI API
  - Grok API (xAI)
  - Gemini API (선택)
- **데이터 저장**: 로컬 파일 시스템 (마크다운)

### 3.2 Phase 2: 웹서비스 (예정)
- **백엔드**:
  - **프레임워크**: FastAPI 또는 Flask
  - **데이터베이스**: SQLite (초기) → PostgreSQL (확장)
  - **인증**: JWT 또는 OAuth2
- **프론트엔드**:
  - **프레임워크**: React 또는 Vue.js
  - **UI 라이브러리**: Material-UI 또는 Tailwind CSS
- **인프라**:
  - **배포**: Docker + Docker Compose
  - **호스팅**: AWS, GCP, 또는 Vercel (프론트엔드)

### 3.3 Phase 3: 모바일 앱 (예정)
- **크로스 플랫폼**: React Native 또는 Flutter
- **네이티브** (선택):
  - iOS: Swift + SwiftUI
  - Android: Kotlin + Jetpack Compose
- **백엔드**: Phase 2 웹서비스 API 재사용

---

## 4. 개발 단계별 계획

### 4.1 Phase 1: 로컬 스크립트 개선 (1-2주)

#### 4.1.1 현재 상태 분석
- ✅ 기본 협업 프로세스 구현 완료
- ✅ OpenAI + Grok 통합 완료
- ⚠️ 개선 필요 사항:
  - 에러 핸들링 강화
  - 로깅 시스템 추가
  - 설정 파일 관리 개선
  - Gemini 통합 (선택적 3차 검증)

#### 4.1.2 개선 작업
1. **에러 핸들링 및 재시도 로직 강화**
   - API 호출 실패 시 자동 재시도
   - Fallback 모델 자동 선택
   - 상세한 에러 로그 기록

2. **로깅 시스템 구축**
   - 파일 기반 로그 (일별 로그 파일)
   - 로그 레벨 관리 (DEBUG, INFO, WARNING, ERROR)
   - 실행 시간 및 성능 메트릭 기록

3. **설정 관리 개선**
   - YAML 또는 JSON 기반 설정 파일
   - 환경별 설정 분리 (개발/프로덕션)
   - API 키 안전 관리 (.env 파일)

4. **Gemini 통합 (선택)**
   - 3차 검증자 역할로 추가
   - 데이터 정확성 집중 검증

5. **테스트 코드 작성**
   - 단위 테스트 (각 함수별)
   - 통합 테스트 (전체 워크플로우)
   - 모의(Mock) API 응답 테스트

#### 4.1.3 검증 기준
- [ ] 모든 AI 모델 호출 성공률 > 95%
- [ ] 보고서 생성 시간 < 5분
- [ ] 에러 발생 시 자동 복구 가능
- [ ] 로그 파일로 모든 실행 이력 추적 가능

---

### 4.2 Phase 2: 웹서비스 개발 (4-6주)

#### 4.2.1 백엔드 개발 (2-3주)

**주요 기능:**
1. **RESTful API 설계**
   ```
   POST   /api/reports/generate     # 보고서 생성 요청
   GET    /api/reports/{id}         # 보고서 조회
   GET    /api/reports              # 보고서 목록 조회
   POST   /api/portfolio            # 포트폴리오 데이터 업로드
   GET    /api/portfolio            # 포트폴리오 데이터 조회
   PUT    /api/portfolio            # 포트폴리오 데이터 업데이트
   GET    /api/market-data          # 시장 데이터 조회
   POST   /api/settings             # 설정 저장
   GET    /api/settings             # 설정 조회
   ```

2. **데이터베이스 스키마**
   ```sql
   -- 포트폴리오 데이터
   portfolios (id, user_id, name, created_at, updated_at)
   portfolio_items (id, portfolio_id, symbol, quantity, avg_price, account_type)
   
   -- 보고서
   reports (id, portfolio_id, generated_at, status, file_path)
   report_versions (id, report_id, version, content, ai_models_used)
   
   -- 설정
   user_settings (user_id, ai_models, prompt_template, notification_settings)
   ```

3. **비동기 작업 처리**
   - Celery 또는 FastAPI Background Tasks
   - 보고서 생성 작업 큐 관리
   - 진행 상황 실시간 업데이트 (WebSocket)

4. **인증 및 권한**
   - JWT 기반 인증
   - 사용자별 데이터 격리
   - API 키 관리

#### 4.2.2 프론트엔드 개발 (2-3주)

**주요 페이지:**
1. **대시보드**
   - 최근 보고서 목록
   - 포트폴리오 요약 정보
   - 빠른 액션 (새 보고서 생성)

2. **포트폴리오 관리**
   - 포트폴리오 입력/수정 폼
   - 종목별 상세 정보 입력
   - 계좌별 구분 관리

3. **보고서 생성**
   - 설정 선택 (AI 모델 조합, 프롬프트 템플릿)
   - 진행 상황 표시 (실시간 업데이트)
   - 생성 완료 후 미리보기

4. **보고서 조회**
   - 마크다운 렌더링
   - PDF 다운로드
   - 이전 보고서와 비교

5. **설정**
   - AI 모델 선택
   - 프롬프트 템플릿 편집
   - 알림 설정

#### 4.2.3 배포 및 인프라 (1주)
- Docker 컨테이너화
- CI/CD 파이프라인 구축
- 환경 변수 관리
- 모니터링 및 로깅 시스템

#### 4.2.4 검증 기준
- [ ] API 응답 시간 < 2초 (조회), < 30초 (생성 시작)
- [ ] 동시 사용자 10명 이상 지원
- [ ] 보고서 생성 성공률 > 98%
- [ ] 모바일 반응형 디자인 적용

---

### 4.3 Phase 3: 모바일 앱 개발 (6-8주)

#### 4.3.1 핵심 기능
1. **포트폴리오 입력** (간편 입력 UI)
2. **보고서 생성 및 조회**
3. **푸시 알림** (일일 보고서, 중요 이벤트)
4. **오프라인 모드** (최근 보고서 캐싱)

#### 4.3.2 기술 선택
- **크로스 플랫폼**: React Native 또는 Flutter
- **상태 관리**: Redux 또는 Provider
- **네비게이션**: React Navigation 또는 Flutter Navigation

#### 4.3.3 검증 기준
- [ ] iOS/Android 양쪽 플랫폼 지원
- [ ] 앱 시작 시간 < 3초
- [ ] 오프라인 모드에서 최근 보고서 조회 가능
- [ ] 푸시 알림 정상 작동

---

## 5. AI 서비스 통합 전략

### 5.1 지원 AI 서비스
1. **OpenAI** (필수)
   - 모델: gpt-4o, gpt-4-turbo, gpt-3.5-turbo
   - 역할: 주 작성자, 최종 통합

2. **Grok (xAI)** (필수)
   - 모델: grok-4, grok-4-1-fast-reasoning
   - 역할: 리뷰어, 비판적 분석

3. **Gemini (Google)** (선택)
   - 모델: gemini-pro, gemini-ultra
   - 역할: 데이터 검증, 수치 계산 검토

4. **Claude (Anthropic)** (향후)
   - 모델: claude-3-opus, claude-3-sonnet
   - 역할: 추가 검증, 보완 분석

### 5.2 협업 워크플로우

#### 기본 워크플로우 (2-AI)
```
포트폴리오 데이터
    ↓
[OpenAI] 초안 작성
    ↓
[Grok] 리뷰 및 코멘트
    ↓
[OpenAI] 리뷰 반영하여 최종 보고서
```

#### 고급 워크플로우 (3-AI)
```
포트폴리오 데이터
    ↓
[OpenAI] 초안 작성
    ↓
[Grok] 리뷰 및 코멘트
    ↓
[Gemini] 데이터 정확성 검증
    ↓
[OpenAI] 모든 피드백 반영하여 최종 보고서
```

### 5.3 에러 핸들링
- **API 실패 시**: Fallback 모델 자동 선택
- **부분 실패 시**: 성공한 AI 결과만으로 보고서 생성
- **전체 실패 시**: 사용자에게 알림 및 재시도 옵션 제공

---

## 6. 데이터 흐름

### 6.1 입력 데이터
```
사용자 입력
    ↓
포트폴리오 정보 (JSON/YAML)
    ├─ 계좌 정보
    ├─ 보유 종목
    ├─ 목표 설정
    └─ 운영 전략
    ↓
시장 데이터 수집 (웹 스크래핑/API)
    ├─ 환율
    ├─ 주가
    └─ 시장 현황
```

### 6.2 처리 과정
```
통합 데이터
    ↓
AI-1 프롬프트 생성
    ↓
AI-1 초안 생성
    ↓
AI-2 리뷰 프롬프트 생성
    ↓
AI-2 리뷰 코멘트
    ↓
AI-1 최종 프롬프트 생성
    ↓
최종 보고서
```

### 6.3 출력 데이터
```
최종 보고서 (마크다운)
    ├─ 메타데이터 (생성일, 사용 모델)
    ├─ 본문 (모든 섹션)
    └─ 리뷰 과정 (참고용)
    ↓
파일 저장 + 데이터베이스 기록
```

---

## 7. UI/UX 고려사항

### 7.1 로컬 스크립트 (CLI)
- **진행 상황 표시**: 단계별 진행률 표시
- **에러 메시지**: 명확하고 해결 방법 제시
- **결과 확인**: 생성된 파일 경로 명확히 표시

### 7.2 웹서비스
- **직관적인 네비게이션**: 최소 클릭으로 원하는 기능 접근
- **실시간 피드백**: 보고서 생성 진행 상황 실시간 표시
- **반응형 디자인**: 모바일/태블릿/데스크톱 모두 지원
- **다크 모드**: 눈의 피로 감소

### 7.3 모바일 앱
- **간편 입력**: QR 코드 스캔, 사진 인식 등
- **오프라인 지원**: 최근 보고서 캐싱
- **푸시 알림**: 중요 이벤트 알림

---

## 8. 보안 및 개인정보 보호

### 8.1 데이터 보안
- **API 키 관리**: 환경 변수 또는 암호화된 저장소
- **포트폴리오 데이터 암호화**: 민감한 금융 정보 보호
- **HTTPS 통신**: 모든 API 통신 암호화

### 8.2 개인정보 보호
- **데이터 최소화**: 필요한 정보만 수집
- **데이터 보관 기간**: 사용자 설정에 따라 자동 삭제
- **GDPR 준수**: 유럽 사용자 대응

---

## 9. 성공 지표 (KPI)

### 9.1 기능적 지표
- **보고서 생성 성공률**: > 98%
- **보고서 생성 시간**: < 5분 (로컬), < 30초 시작 (웹)
- **AI 모델 호출 성공률**: > 95%
- **에러 발생률**: < 2%

### 9.2 품질 지표
- **사용자 만족도**: 설문조사 기반
- **보고서 정확도**: 수동 검증 또는 AI 자체 검증
- **리뷰 코멘트 유용성**: 사용자 피드백

### 9.3 사용성 지표
- **사용자 수**: 활성 사용자 (DAU/MAU)
- **보고서 생성 빈도**: 사용자당 평균 생성 횟수
- **기능 사용률**: 각 기능별 사용 비율

---

## 10. 향후 확장 계획

### 10.1 추가 AI 서비스
- Claude (Anthropic)
- Llama (Meta, 자체 호스팅)
- Mistral AI

### 10.2 고급 기능
- **포트폴리오 백테스팅**: 과거 데이터 기반 전략 검증
- **AI 기반 투자 추천**: 포트폴리오 최적화 제안
- **실시간 모니터링**: 주가 변동 알림 및 자동 분석
- **소셜 기능**: 보고서 공유, 커뮤니티 토론

### 10.3 통합 기능
- **증권사 API 연동**: 자동 포트폴리오 데이터 수집
- **알림 서비스**: Slack, Discord, 이메일 연동
- **클라우드 저장소**: Google Drive, Dropbox 연동

---

## 11. 리스크 및 대응 방안

### 11.1 기술적 리스크
- **AI API 장애**: Fallback 모델, 캐싱 전략
- **데이터 수집 실패**: 대체 데이터 소스, 수동 입력 옵션
- **성능 저하**: 비동기 처리, 캐싱, 최적화

### 11.2 비즈니스 리스크
- **API 비용 증가**: 사용량 모니터링, 비용 최적화
- **규제 변경**: 금융 데이터 처리 규정 준수
- **경쟁 서비스**: 차별화된 기능 강화

---

## 12. 프로젝트 일정 (예상)

| Phase | 기간 | 주요 마일스톤 |
|-------|------|--------------|
| Phase 1 (로컬 개선) | 1-2주 | 에러 핸들링 강화, 로깅 시스템, Gemini 통합 |
| Phase 2 (웹서비스) | 4-6주 | 백엔드 API (2-3주), 프론트엔드 (2-3주), 배포 (1주) |
| Phase 3 (모바일 앱) | 6-8주 | 크로스 플랫폼 개발, 테스트, 배포 |

**총 예상 기간**: 11-16주 (약 3-4개월)

---

## 13. 참고 자료

### 13.1 기존 문서
- `portfolio_prompt.txt`: 포트폴리오 운영 프롬프트
- `.portfolio-rules`: 보고서 생성 규칙
- `scripts/README.md`: 스크립트 사용 가이드

### 13.2 외부 리소스
- OpenAI API 문서: https://platform.openai.com/docs
- Grok API 문서: https://docs.x.ai/
- Gemini API 문서: https://ai.google.dev/docs

---

## 14. 다음 단계

### 즉시 시작 가능한 작업
1. ✅ **PDR 문서 작성 완료** (현재)
2. ⏭️ **Phase 1 개선 작업 시작**
   - 에러 핸들링 강화
   - 로깅 시스템 구축
   - Gemini 통합 검토

### 결정 필요 사항
- 웹서비스 프레임워크 선택 (FastAPI vs Flask)
- 프론트엔드 프레임워크 선택 (React vs Vue.js)
- 모바일 앱 기술 선택 (React Native vs Flutter)
- 호스팅 플랫폼 선택 (AWS vs GCP vs 기타)

---

**문서 버전**: 1.0  
**최종 수정일**: 2026년 1월 26일  
**작성자**: AI Assistant  
**검토 필요**: 프로젝트 팀 리뷰 및 승인
